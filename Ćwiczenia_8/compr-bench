#!/usr/bin/env bash
set -u
trap 'cleanup_tmpdir' EXIT

TMP_DIR=""
cleanup_tmpdir() {
  if [ -n "${TMP_DIR:-}" ] && [ -d "$TMP_DIR" ]; then
    rm -rf "$TMP_DIR"
  fi
}

required=(tar date bc stat)
compressors=(gzip bzip2 xz zstd lz4 7z)
missing=()
for cmd in "${required[@]}"; do
  if ! command -v "$cmd" >/dev/null 2>&1; then
    missing+=("$cmd")
  fi
done
for cmd in "${compressors[@]}"; do
  if ! command -v "$cmd" >/dev/null 2>&1; then
  fi
done
if [ "${#missing[@]}" -ne 0 ]; then
  exit 1
fi

time_now() { date +%s.%N; }
time_diff() {
  echo "$(echo "$2 - $1" | bc -l)"
}
ratio_pct() {
  local comp=$1 orig=$2
  if [ "$orig" -eq 0 ]; then
    echo "0.00"
  else
    echo "$(echo "scale=4; $comp * 100 / $orig" | bc -l)"
  fi
}

run_algo() {
  local algo=$1
  local tarfile=$2
  local tmp=$3
  local compfile extracted start end ctime dtime orig_size comp_size ratio

  orig_size=$(stat -c%s "$tarfile")

  case "$algo" in
    gzip)
      compfile="$tmp/archive.tar.gz"
      start=$(time_now)
      gzip -c "$tarfile" > "$compfile"
      end=$(time_now)
      ctime=$(time_diff "$start" "$end")

      start=$(time_now)
      gzip -d -c "$compfile" > "$tmp/extracted.tar"
      end=$(time_now)
      dtime=$(time_diff "$start" "$end")
      ;;
    bzip2)
      compfile="$tmp/archive.tar.bz2"
      start=$(time_now)
      bzip2 -c "$tarfile" > "$compfile"
      end=$(time_now)
      ctime=$(time_diff "$start" "$end")

      start=$(time_now)
      bzip2 -d -c "$compfile" > "$tmp/extracted.tar"
      end=$(time_now)
      dtime=$(time_diff "$start" "$end")
      ;;
    xz)
      compfile="$tmp/archive.tar.xz"
      start=$(time_now)
      xz -c "$tarfile" > "$compfile"
      end=$(time_now)
      ctime=$(time_diff "$start" "$end")

      start=$(time_now)
      xz -d -c "$compfile" > "$tmp/extracted.tar"
      end=$(time_now)
      dtime=$(time_diff "$start" "$end")
      ;;
    zstd)
      compfile="$tmp/archive.tar.zst"
      start=$(time_now)
      zstd -q -c "$tarfile" > "$compfile"
      end=$(time_now)
      ctime=$(time_diff "$start" "$end")

      start=$(time_now)
      zstd -q -d -c "$compfile" > "$tmp/extracted.tar"
      end=$(time_now)
      dtime=$(time_diff "$start" "$end")
      ;;
    lz4)
      compfile="$tmp/archive.tar.lz4"
      start=$(time_now)
      lz4 -c "$tarfile" > "$compfile"
      end=$(time_now)
      ctime=$(time_diff "$start" "$end")

      start=$(time_now)
      lz4 -d -c "$compfile" > "$tmp/extracted.tar"
      end=$(time_now)
      dtime=$(time_diff "$start" "$end")
      ;;
    7z)
      compfile="$tmp/archive.tar.7z"
      start=$(time_now)
      7z a -bd -y "$compfile" "$tarfile" >/dev/null 2>&1
      end=$(time_now)
      ctime=$(time_diff "$start" "$end")

      start=$(time_now)
      7z x -so "$compfile" > "$tmp/extracted.tar" 2>/dev/null
      end=$(time_now)
      dtime=$(time_diff "$start" "$end")
      ;;
    *)
      return 1
      ;;
  esac

  if [ -f "$compfile" ]; then
    comp_size=$(stat -c%s "$compfile")
  else
    comp_size=0
  fi

  ratio=$(ratio_pct "$comp_size" "$orig_size")
  printf "%s\t%s\t%s\t%s%%\n" "$algo" "$ctime" "$dtime" "$ratio"

  rm -f "$compfile" "$tmp/extracted.tar"
}

algos=(gzip bzip2 xz zstd lz4 7z)

if [ "$#" -lt 1 ]; then
  echo "Usage: $0 <dir1> [dir2 ...]" >&2
  exit 2
fi

TMP_DIR=$(mktemp -d)
for dir in "$@"; do
  if [ ! -d "$dir" ]; then
    continue
  fi

  printf "%s\n" "$dir"
  printf "name\tcompress\tdecompress\tratio\n"

  tarfile="$TMP_DIR/archive.tar"
  ( cd "$dir" && tar cvf "$tarfile" . ) >/dev/null 2>&1

  if [ ! -f "$tarfile" ]; then
    continue
  fi

  for a in "${algos[@]}"; do
    if command -v "$a" >/dev/null 2>&1; then
      run_algo "$a" "$tarfile" "$TMP_DIR"
    else
      printf "%s\t%s\t%s\t%s\n" "$a" "N/A" "N/A" "N/A"
    fi
  done

  rm -f "$tarfile"

  printf "\n"
done

exit 0
