#!/bin/bash

measure_time() {
    local start
    local end
    local result
    start=$(date +%s.%N)
    "$@"
    end=$(date +%s.%N)
    result=$(echo "scale=10; $end - $start" | bc -l)
    echo "$result"
}

cleanup() {
    local tmp_dir=$1
    rm -rf "$tmp_dir"
    echo "Usuwanie katalogu tymczasowego: $tmp_dir"
}

if [ $# -eq 0 ]; then
    echo "Użycie: $0 <katalog1> [<katalog2> ...]"
    exit 1
fi

COMPRESSORS=(
    "gzip|-f|-d -f|.gz"
    "bzip2|-f|-d -f|.bz2"
    "xz||-d|.xz"
    "zstd||-d|.zst"
    "lz4||-d|.lz4"
    "7z|a -mmt=off -t7z|e|.7z"
)

HEADER="name\tcompress\tdecompress\tratio"

for DATA_DIR in "$@"; do
    if [ ! -d "$DATA_DIR" ]; then
        echo "Katalog nie istnieje lub nie jest katalogiem: $DATA_DIR" >&2
        continue
    fi

    tmp_dir=$(mktemp -d)
    echo ""
    echo "$DATA_DIR"
    echo -e "$HEADER"

    BASE_NAME=$(basename "$DATA_DIR")
    MASTER_TAR_FILE="$tmp_dir/$BASE_NAME.master.tar"
    
    if ! tar cvf "$MASTER_TAR_FILE" -C "$(dirname "$DATA_DIR")" "$BASE_NAME" > /dev/null 2>&1; then
        echo "Błąd tworzenia archiwum tar dla $DATA_DIR" >&2
        cleanup "$tmp_dir"
        continue
    fi
    
    ORIGINAL_SIZE=$(stat -c %s "$MASTER_TAR_FILE")

    for COMPRESSOR in "${COMPRESSORS[@]}"; do
        IFS='|' read -r NAME COMPRESS_OPTS DECOMPRESS_OPTS EXTENSION <<< "$COMPRESSOR"
        
        CURRENT_TAR_FILE="$tmp_dir/$NAME.$BASE_NAME.tar"
        
        cp "$MASTER_TAR_FILE" "$CURRENT_TAR_FILE"

        if [ "$NAME" = "7z" ]; then
            COMPRESSED_FILE="$tmp_dir/$BASE_NAME.7z"
            COMPRESS_CMD="$NAME $COMPRESS_OPTS $COMPRESSED_FILE $CURRENT_TAR_FILE"
        else
            COMPRESSED_FILE="$CURRENT_TAR_FILE$EXTENSION"
            COMPRESS_CMD="$NAME $COMPRESS_OPTS $CURRENT_TAR_FILE"
        fi

        COMPRESS_TIME=$(measure_time eval "$COMPRESS_CMD > /dev/null 2>&1")
        
        if [ $? -ne 0 ]; then
            echo -e "$NAME\tBłąd kompresji\t-\t-"
            rm -f "$CURRENT_TAR_FILE" "$COMPRESSED_FILE"
            continue
        fi

        if [ -f "$COMPRESSED_FILE" ]; then
            COMPRESSED_SIZE=$(stat -c %s "$COMPRESSED_FILE")
            RATIO=$(echo "scale=1; ($COMPRESSED_SIZE * 100) / $ORIGINAL_SIZE" | bc -l)
        else
            echo -e "$NAME\t$COMPRESS_TIME\t-\tBłąd pliku"
            continue
        fi

        DECOMPRESS_SUCCESS=false

        if [ "$NAME" = "7z" ]; then
            cp "$COMPRESSED_FILE" "$COMPRESSED_FILE.tmp"
            DECOMPRESS_CMD="$NAME $DECOMPRESS_OPTS $COMPRESSED_FILE.tmp -o$tmp_dir"
            DECOMPRESS_TIME=$(measure_time $DECOMPRESS_CMD > /dev/null 2>&1)
            
            if [ -f "$MASTER_TAR_FILE" ]; then 
                 DECOMPRESSED_TAR_FILE="$tmp_dir/$NAME.$BASE_NAME.decompress.tar"
                 rm -f "$MASTER_TAR_FILE"
                 
                 if [ $? -eq 0 ]; then
                     DECOMPRESS_SUCCESS=true
                 fi
                 
            fi
            rm -f "$COMPRESSED_FILE.tmp"
            
        else
            DECOMPRESS_CMD="$NAME $DECOMPRESS_OPTS $COMPRESSED_FILE"
            DECOMPRESS_TIME=$(measure_time $DECOMPRESS_CMD > /dev/null 2>&1)
            
            if [ -f "$CURRENT_TAR_FILE" ]; then
                DECOMPRESS_SUCCESS=true
            fi
        fi

        if [ "$DECOMPRESS_SUCCESS" = true ]; then
            echo -e "$NAME\t$COMPRESS_TIME\t$DECOMPRESS_TIME\t$RATIO%"
        else
             echo -e "$NAME\t$COMPRESS_TIME\tBłąd dekompresji\t$RATIO%"
        fi
        
        rm -f "$COMPRESSED_FILE" "$CURRENT_TAR_FILE"

    done
    
    rm -f "$MASTER_TAR_FILE"
    cleanup "$tmp_dir"

done